---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getLocale, type Locale, t } from "../lib/i18n";
import { getSiteSettings, urlFor } from "../lib/sanity";
import "../styles/global.css";
import { ViewTransitions } from "astro:transitions";

interface Props {
  title: string;
  description?: string;
  locale?: Locale;
  seo?: any;
}

const { title, description: propDescription, seo } = Astro.props;

const locale = getLocale(Astro.url);
const settings = await getSiteSettings();

const metaTitle =
  t(seo?.metaTitle, locale) ||
  title ||
  t(settings?.globalSeo?.metaTitle, locale) ||
  t(settings?.siteTitle, locale);
const metaDescription =
  t(seo?.metaDescription, locale) ||
  propDescription ||
  t(settings?.globalSeo?.metaDescription, locale) ||
  t(settings?.tagline, locale) ||
  "Bamboo Shoots – Bildung. Gemeinschaft. Perspektiven für Kinder in Kambodscha.";

const shareImageUrl =
  (seo?.shareImage &&
    urlFor(seo.shareImage).width(1200).height(630).fit("crop").url()) ||
  (settings?.globalSeo?.shareImage &&
    urlFor(settings.globalSeo.shareImage)
      .width(1200)
      .height(630)
      .fit("crop")
      .url()) ||
  (settings?.shareImage &&
    urlFor(settings.shareImage).width(1200).height(630).fit("crop").url()) ||
  null;

const faviconLightUrl =
  (settings?.logoDark &&
    urlFor(settings.logoDark).width(32).height(32).format("png").url()) ||
  null;

const faviconDarkUrl =
  (settings?.logoLight &&
    urlFor(settings.logoLight).width(32).height(32).format("png").url()) ||
  null;
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={metaDescription} />
    <meta name="robots" content="index, follow" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&family=Noto+Sans+Khmer:wght@300;400;500;600;700&family=Caveat:wght@400;700&display=swap"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&family=Noto+Sans+Khmer:wght@300;400;500;600;700&family=Caveat:wght@400;700&display=swap"
      />
    </noscript>

    <!-- Open Graph -->
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    {shareImageUrl && <meta property="og:image" content={shareImageUrl} />}
    <meta
      property="og:locale"
      content={locale === "de" ? "de_DE" : locale === "en" ? "en_US" : "km_KH"}
    />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />
    {shareImageUrl && <meta name="twitter:image" content={shareImageUrl} />}

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href={`${import.meta.env.BASE_URL}favicon.svg`}
    />
    {
      faviconDarkUrl && (
        <link
          rel="icon"
          type="image/png"
          href={faviconDarkUrl}
          media="(prefers-color-scheme: dark)"
        />
      )
    }
    {
      faviconLightUrl && (
        <link
          rel="icon"
          type="image/png"
          href={faviconLightUrl}
          media="(prefers-color-scheme: light)"
        />
      )
    }

    <title>{metaTitle} | Bamboo Shoots</title>
    <ViewTransitions />
  </head>
  <body class="min-h-screen flex flex-col">
    <Header locale={locale} settings={settings} />

    <main class="flex-grow">
      <slot />
    </main>

    <Footer locale={locale} settings={settings} />

    <script>
      // Helper to handle smooth transition choreography
      const initChoreography = () => {
        const html = document.documentElement;

        // 1. Disable smooth scroll immediately to allow "beaming" to anchors
        html.classList.remove("is-ready");

        // 2. Global reveal observer logic
        const initReveals = () => {
          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  entry.target.classList.add("visible");
                }
              });
            },
            { threshold: 0.1 },
          );

          document
            .querySelectorAll(".reveal")
            .forEach((el) => observer.observe(el));
        };

        // 3. Timing: Wait for the 0.5s View Transition to finish before revealing content
        setTimeout(() => {
          initReveals();
          // After transition is done, re-enable smooth scroll for in-page navigation
          html.classList.add("is-ready");
        }, 300);
      };

      const handleRedirect = () => {
        const path = window.location.pathname;
        const base = (import.meta.env.BASE_URL || "/").replace(/\/$/, "");

        // Only redirect if we are EXACTLY at the root
        const isRoot = path === base + "/" || path === base;
        if (!isRoot) return;

        const lang = localStorage.getItem("preferred-language");
        if (lang) {
          // If preference exists and is not German, redirect
          if (lang !== "de") {
            window.location.replace(base + "/" + lang + "/");
          }
          return;
        }

        // First visit: Detect browser language
        const browserLang = navigator.language.split("-")[0];
        const supportedNonDefault = ["en", "kh"];

        if (supportedNonDefault.includes(browserLang)) {
          localStorage.setItem("preferred-language", browserLang);
          window.location.replace(base + "/" + browserLang + "/");
        } else {
          // It's German or an unsupported language -> stay here and mark as German
          localStorage.setItem("preferred-language", "de");
        }
      };

      document.addEventListener("astro:page-load", () => {
        initChoreography();
        handleRedirect();
      });
    </script>
  </body>
</html>
