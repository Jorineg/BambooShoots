---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getLocale, type Locale } from "../lib/i18n";
import { getSiteSettings } from "../lib/sanity";
import "../styles/global.css";
import { ViewTransitions } from "astro:transitions";

interface Props {
  title: string;
  description?: string;
  locale?: Locale;
}

const {
  title,
  description = "Bamboo Shoots – Bildung. Gemeinschaft. Perspektiven für Kinder in Kambodscha.",
} = Astro.props;
const locale = getLocale(Astro.url);
const settings = await getSiteSettings();
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="robots" content="index, follow" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta
      property="og:locale"
      content={locale === "de" ? "de_DE" : locale === "en" ? "en_US" : "km_KH"}
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href={`${import.meta.env.BASE_URL}favicon.svg`}
    />

    <title>{title} | Bamboo Shoots</title>
    <ViewTransitions />
  </head>
  <body class="min-h-screen flex flex-col">
    <Header locale={locale} settings={settings} />

    <main class="flex-grow">
      <slot />
    </main>

    <Footer locale={locale} settings={settings} />

    <script>
      // Helper to handle smooth transition choreography
      const initChoreography = () => {
        const html = document.documentElement;

        // 1. Disable smooth scroll immediately to allow "beaming" to anchors
        html.classList.remove("is-ready");

        // 2. Global reveal observer logic
        const initReveals = () => {
          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  entry.target.classList.add("visible");
                }
              });
            },
            { threshold: 0.1 },
          );

          document
            .querySelectorAll(".reveal")
            .forEach((el) => observer.observe(el));
        };

        // 3. Timing: Wait for the 0.5s View Transition to finish before revealing content
        setTimeout(() => {
          initReveals();
          // After transition is done, re-enable smooth scroll for in-page navigation
          html.classList.add("is-ready");
        }, 300);
      };

      // Language redirect logic (Root only)
      const handleRedirect = () => {
        const path = window.location.pathname;
        const base = (import.meta.env.BASE_URL || "/").replace(/\/$/, "");

        // Only redirect on actual root variants
        const isRoot = path === "/" || path === base || path === base + "/";
        if (!isRoot) return;

        const lang = localStorage.getItem("preferred-language");
        if (lang) {
          if (lang !== "de") {
            const target = base + "/" + lang + "/";
            if (path !== target) window.location.href = target;
          }
          return;
        }

        const browserLang = navigator.language.split("-")[0];
        const supportedLocales = ["de", "en", "kh"];
        const targetLocale = supportedLocales.includes(browserLang)
          ? browserLang
          : "en";

        if (targetLocale !== "de") {
          localStorage.setItem("preferred-language", targetLocale);
          window.location.href = base + "/" + targetLocale + "/";
        } else {
          localStorage.setItem("preferred-language", "de");
        }
      };

      document.addEventListener("astro:page-load", () => {
        initChoreography();
        handleRedirect();
      });
    </script>
  </body>
</html>
