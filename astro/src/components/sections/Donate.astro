---
import { t, type Locale } from "../../lib/i18n";
import SanityImage from "../SanityImage.astro";

interface Props {
    locale: Locale;
    tiers: any[];
    settings: any;
}

const { locale, tiers, settings } = Astro.props;

// Default donation tiers
const defaultTiers = [
    {
        amount: 35,
        title: {
            de: "Vorschulplatz finanzieren",
            en: "Fund a Preschool Place",
            kh: "ផ្តល់មូលនិធិកន្លែងមត្តេយ្យ",
        },
        description: {
            de: "Ihre Spende ermöglicht es einem Kind 5 x pro Woche in die Vorschule gehen zu können – inklusive Mahlzeit & Material.",
            en: "Your donation enables a child to attend preschool 5x per week – including meal & materials.",
            kh: "ការបរិច្ចាគរបស់អ្នកអាចឱ្យកុមារចូលរៀនមត្តេយ្យ 5 ដង/សប្តាហ៍ – រួមទាំងអាហារ និងសម្ភារៈ។",
        },
    },
    {
        amount: 15,
        title: {
            de: "Nachmittags-förderung",
            en: "Afternoon Support",
            kh: "ការគាំទ្រពេលរសៀល",
        },
        description: {
            de: "3 x pro Woche an zwei Standorten + Englisch – inklusive Mahlzeit & Material.",
            en: "3x per week at two locations + English – including meal & materials.",
            kh: "3 ដង/សប្តាហ៍ នៅពីរទីតាំង + អង់គ្លេស – រួមទាំងអាហារ និងសម្ភារៈ។",
        },
    },
    {
        amount: null,
        title: {
            de: "Krisenhilfe & Gemeindearbeit",
            en: "Crisis Aid & Community Work",
            kh: "ជំនួយវិបត្តិ និងការងារសហគមន៍",
        },
        description: {
            de: "Krisenhilfe & Gemeindearbeit für beispielsweise Fahrräder, Reis- oder Hygienepakete.",
            en: "Crisis aid & community work for bicycles, rice or hygiene packages.",
            kh: "ជំនួយវិបត្តិ និងការងារសហគមន៍សម្រាប់កង់ អង្ករ ឬកញ្ចប់អនាម័យ។",
        },
    },
];

const displayTiers = tiers?.length > 0 ? tiers : defaultTiers;

const heroImageSource = settings?.donationBgImage;
const fallbackHero = `${import.meta.env.BASE_URL}images/donation_bg.png`;
---

<section
    id="spenden"
    class="donate-container relative py-16 md:py-48 overflow-hidden bg-branding-dark text-white"
>
    <!-- Parallax Background -->
    <div class="absolute inset-0 z-0">
        <div
            class="parallax-container absolute inset-0 w-full h-full animate-fade-in opacity-0"
            style="animation-delay: 0.3s;"
        >
            {
                heroImageSource ? (
                    <div class="parallax-target-slow absolute top-[-10%] left-0 w-full h-[120%]">
                        <SanityImage
                            id="donate-parallax-img"
                            src={heroImageSource}
                            alt=""
                            class="w-full h-full object-cover opacity-40"
                            loading="lazy"
                            widths={[640, 768, 1024, 1280, 1536, 1920]}
                            sizes="100vw"
                        />
                    </div>
                ) : (
                    <div class="parallax-target-slow absolute top-[-10%] left-0 w-full h-[120%]">
                        <img
                            id="donate-parallax-img"
                            src={fallbackHero}
                            alt=""
                            class="w-full h-full object-cover opacity-40"
                            loading="lazy"
                        />
                    </div>
                )
            }
        </div>
        <!-- Cinematic Depth Overlays (Neutral) -->
        <div class="absolute inset-0 bg-branding-dark/30"></div>
        <div
            class="absolute inset-0 bg-gradient-to-t from-branding-dark via-transparent to-branding-dark/60"
        >
        </div>
    </div>

    <div class="container-custom relative z-10">
        <!-- Section header -->
        <div
            class="max-w-4xl mb-16 md:mb-32 reveal border-l-[3px] border-primary/40 pl-6 md:pl-16"
        >
            <h3
                class="text-4xl md:text-6xl font-heading font-extrabold text-white mb-10 tracking-tight"
            >
                {
                    t(settings?.donateSection?.title, locale) ||
                        (locale === "de"
                            ? "Spenden & Mitmachen"
                            : locale === "en"
                              ? "Donate & Get Involved"
                              : "បរិច្ចាគ និងចូលរួម")
                }
            </h3>
            <p
                class="text-white/60 text-lg md:text-2xl max-w-2xl font-light leading-relaxed"
            >
                {
                    t(settings?.donateSection?.intro, locale) ||
                        (locale === "de"
                            ? "Ihre Unterstützung macht den Unterschied. Spenden Sie gezielt – transparent und wirkungsvoll."
                            : locale === "en"
                              ? "Your support makes the difference. Donate purposefully – transparently and effectively."
                              : "ការគាំទ្ររបស់អ្នកបង្កើតភាពខុសគ្នា។ បរិច្ចាគដោយមានគោលបំណង។")
                }
            </p>
        </div>

        <!-- Donation tiers -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 mb-16 md:mb-32 items-stretch">
            {
                displayTiers.map((tier, index) => {
                    const paypalUrl =
                        settings?.donationLinks?.paypal && tier.amount
                            ? `${settings.donationLinks.paypal.replace(/\/$/, "")}/${tier.amount}`
                            : settings?.donationLinks?.paypal;

                    // Different background styles for each tier
                    const tierBgClasses = [
                        "bg-white/[0.08] hover:bg-white/[0.12]", // Tier 1 - lightest, more white
                        "bg-[#1a4d2e]/60 hover:bg-[#1a4d2e]/75", // Tier 2 - medium green
                        "bg-[#0f3d22]/80 hover:bg-[#0f3d22]/90", // Tier 3 - darkest green
                    ];

                    return (
                        <div
                            class={`group relative ${tierBgClasses[index]} backdrop-blur-xl rounded-[2rem] md:rounded-[2.5rem] p-8 md:p-10 border border-white/10 transition-all duration-700 reveal flex flex-col`}
                            style={`transition-delay: ${index * 150}ms`}
                        >
                            {index === 0 && (
                                <div class="absolute -top-4 left-8 bg-secondary text-white text-[10px] uppercase tracking-[0.2em] font-bold px-5 py-2 rounded-full shadow-lg">
                                    {locale === "de"
                                        ? "Vorschlag"
                                        : locale === "en"
                                          ? "Suggested"
                                          : "សំណើ"}
                                </div>
                            )}

                            {/* Title - large heading with fixed min-height for alignment */}
                            <h4 class="text-3xl md:text-4xl font-heading font-extrabold mb-4 text-white leading-tight tracking-tight min-h-[4.5rem] md:min-h-[5.5rem]">
                                {t(tier.title, locale)}
                            </h4>

                            {/* Amount with "mit einmalig" prefix - fixed height for alignment */}
                            <p class="text-white/70 text-base md:text-lg mb-6 min-h-[1.75rem]">
                                {tier.amount ? (
                                    <>
                                        {locale === "de"
                                            ? "mit einmalig "
                                            : locale === "en"
                                              ? "with a one-time "
                                              : "ជាមួយ "}
                                        <span class="font-extrabold text-white">{tier.amount}€</span>
                                    </>
                                ) : null}
                            </p>

                            {/* Description */}
                            <p class="text-white/50 text-base leading-relaxed font-light italic flex-grow">
                                {t(tier.description, locale)}
                            </p>

                            {/* Donate button - pushed to bottom */}
                            <a
                                href={paypalUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="flex items-center gap-3 text-secondary font-bold text-xs uppercase tracking-[0.15em] group-hover:translate-x-2 transition-transform duration-500 mt-8 pt-6 border-t border-white/10"
                            >
                                <span>
                                    {locale === "de"
                                        ? "Per PayPal spenden"
                                        : locale === "en"
                                          ? "Donate via PayPal"
                                          : "បរិច្ចាគតាម PayPal"}
                                </span>
                                <svg
                                    class="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M17 8l4 4m0 0l-4 4m4-4H3"
                                    />
                                </svg>
                            </a>
                        </div>
                    );
                })
            }
        </div>

        <div
            class="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12 items-stretch reveal"
        >
            <!-- Digital Donation -->
            <div
                class="bg-[#0e2a18]/70 hover:bg-[#0e2a18]/85 backdrop-blur-xl rounded-[2rem] md:rounded-[2.5rem] p-8 md:p-16 hover:border-primary/40 flex flex-col transition-all duration-700"
            >
                <h3
                    class="text-white font-heading font-extrabold text-3xl mb-8 md:mb-12"
                >
                    {
                        t(settings?.donateSection?.onlineDonate, locale) ||
                            (locale === "de"
                                ? "Online spenden"
                                : locale === "en"
                                  ? "Donate Online"
                                  : "បរិច្ចាគអនឡាញ")
                    }
                </h3>

                <div class="flex flex-col gap-4 md:gap-6">
                    {
                        settings?.donationLinks?.betterplace && (
                            <a
                                href={settings.donationLinks.betterplace}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="flex items-center justify-between group p-6 md:p-8 bg-white/5 rounded-2xl border border-white/5 hover:bg-white/10 hover:border-white/20 transition-all duration-500"
                            >
                                <span class="text-white font-bold uppercase tracking-widest text-sm">
                                    betterplace.org
                                </span>
                                <svg
                                    class="w-6 h-6 text-white/20 group-hover:text-secondary group-hover:translate-x-2 transition-all duration-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3"
                                    />
                                </svg>
                            </a>
                        )
                    }

                    {
                        settings?.donationLinks?.paypal && (
                            <a
                                href={settings.donationLinks.paypal}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="flex items-center justify-between group p-6 md:p-8 bg-[#0070ba]/20 rounded-2xl border border-[#0070ba]/30 hover:bg-[#0070ba]/40 transition-all duration-500"
                            >
                                <div class="flex items-center gap-2 text-white">
                                    <span class="font-extrabold italic text-xl">
                                        PayPal
                                    </span>
                                </div>
                                <svg
                                    class="w-6 h-6 text-white/50 group-hover:text-white group-hover:translate-x-2 transition-all duration-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3"
                                    />
                                </svg>
                            </a>
                        )
                    }
                </div>
            </div>

            <!-- Bank Transfer Details -->
            <div
                class="bg-[#0e2a18]/70 hover:bg-[#0e2a18]/85 backdrop-blur-xl rounded-[2rem] md:rounded-[2.5rem] p-8 md:p-16 hover:border-primary/40 transition-all duration-700"
            >
                <h3
                    class="text-white font-heading font-extrabold text-3xl mb-12"
                >
                    {
                        t(settings?.donateSection?.bankTransfer, locale) ||
                            (locale === "de"
                                ? "Überweisung"
                                : locale === "en"
                                  ? "Bank Transfer"
                                  : "ផ្ទេរប្រាក់តាមធនាគារ")
                    }
                </h3>
                <div class="space-y-8">
                    {
                        settings?.bankAccount?.[locale] ? (
                            <div class="space-y-6">
                                <div>
                                    <p class="text-white/40 text-[10px] uppercase font-bold tracking-[0.3em] mb-2">
                                        {t(
                                            settings?.donateSection
                                                ?.accountHolder,
                                            locale,
                                        ) ||
                                            (locale === "de"
                                                ? "Empfänger"
                                                : "Beneficiary")}
                                    </p>
                                    <p class="font-bold text-white text-xl">
                                        {settings.bankAccount[locale].name}
                                    </p>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <p class="text-white/40 text-[10px] uppercase font-bold tracking-[0.3em] mb-2">
                                            {t(
                                                settings?.donateSection
                                                    ?.bankName,
                                                locale,
                                            ) ||
                                                (locale === "de"
                                                    ? "Kreditinstitut"
                                                    : "Bank")}
                                        </p>
                                        <p class="text-white font-mono">
                                            {settings.bankAccount[locale].bank}
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-white/40 text-[10px] uppercase font-bold tracking-[0.3em] mb-2">
                                            BIC
                                        </p>
                                        <p class="text-white font-mono uppercase tracking-widest">
                                            {settings.bankAccount[locale].bic}
                                        </p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-white/40 text-[10px] uppercase font-bold tracking-[0.3em] mb-2">
                                        IBAN
                                    </p>
                                    <p class="font-mono text-xl text-secondary break-all tracking-wider">
                                        {settings.bankAccount[locale].iban}
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <p class="italic text-white/30 py-8">
                                {locale === "de"
                                    ? "Details folgen."
                                    : locale === "en"
                                      ? "Details coming soon."
                                      : "ព័ត៌មានធនាគារនឹងមកដល់ក្នុងពេលឆាប់ៗនេះ។"}
                            </p>
                        )
                    }
                </div>
            </div>
        </div>

        <!-- Footer info -->
        <div
            class="mt-16 md:mt-24 pt-12 border-t border-white/10 text-center max-w-3xl mx-auto space-y-6 reveal"
        >
            <p class="text-white/80 font-medium text-lg leading-relaxed italic">
                "{
                    t(settings?.donateSection?.footerInfo, locale) ||
                        t(settings?.donationFooterInfo, locale) ||
                        (locale === "de"
                            ? "Bildung ist kein Privileg, sondern ein Menschenrecht. Wir danken Ihnen für Ihre treue Unterstützung."
                            : locale === "en"
                              ? "Education is not a privilege, but a human right. We thank you for your loyal support."
                              : "ការអប់រំមិនមែនជាឯកសិទ្ធិទេ ប៉ុន្តែជាសិទ្ធិមនុស្ស។")
                }"
            </p>
            <p
                class="text-white/30 text-xs uppercase tracking-[0.3em] font-bold"
            >
                {
                    locale === "de"
                        ? "Ehrenamtlich geführtes Team • 100% Direktförderung"
                        : locale === "en"
                          ? "Volunteer Team • 100% Direct Impact"
                          : "ក្រុមការងារស្ម័គ្រចិត្ត"
                }
            </p>
        </div>
    </div>
</section>

<style>
    .donate-container {
        view-timeline: --donate-v block;
    }

    @keyframes parallax-slow {
        from {
            transform: translateY(0);
        }
        to {
            transform: translateY(15%);
        }
    }

    @supports (animation-timeline: view()) {
        .parallax-target-slow {
            animation: parallax-slow linear both;
            animation-timeline: --donate-v;
            animation-range: entry 0% exit 100%;
        }
    }

    @keyframes fade-in {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .animate-fade-in {
        opacity: 0;
        animation: fade-in 1.5s ease-out both;
    }
</style>

<script is:inline>
    (function () {
        if (
            CSS.supports("animation-timeline", "view()") ||
            CSS.supports("animation-timeline", "scroll()")
        ) {
            return;
        }

        const img = document.getElementById("donate-parallax-img");
        const section = img?.closest("section");
        if (!img || !section) return;

        let ticking = false;
        const update = () => {
            const rect = section.getBoundingClientRect();
            const viewHeight = window.innerHeight;

            if (rect.top < viewHeight && rect.bottom > 0) {
                const scrolled =
                    (viewHeight - rect.top) / (viewHeight + rect.height);
                const yPos = scrolled * 100;
                img.style.transform = `translate3d(0, ${yPos}px, 0)`;
            }
            ticking = false;
        };

        window.addEventListener(
            "scroll",
            () => {
                if (!ticking) {
                    window.requestAnimationFrame(update);
                    ticking = true;
                }
            },
            { passive: true },
        );

        update();
    })();
</script>
