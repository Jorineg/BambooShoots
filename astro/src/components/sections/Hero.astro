---
import { t, type Locale } from '../../lib/i18n';
import { urlFor } from '../../lib/sanity';

interface Props {
  locale: Locale;
  data: any;
}

const { locale, data } = Astro.props;

// Fallback logic
const heroImage = data?.image 
  ? urlFor(data.image).width(1920).quality(90).url() 
  : '/BambooShoots/images/hero_child.png';

const fullTitle = t(data?.title, locale) || '';
const [rawMain, rawAccent] = fullTitle.includes('|') ? fullTitle.split('|') : [fullTitle, ''];

const titleMain = rawMain.trim() || 'Bamboo Shoots';

// Handle accent from separate field or from the split title
const titleAccent = t(data?.titleAccent, locale) || rawAccent.trim() || (
  locale === 'kh' ? 'ពេលវេលាដើម្បីរីកចម្រើន' : 'Time to grow'
);

const subtitle = t(data?.subtitle, locale) || (
  locale === 'de' ? 'Bildung. Gemeinschaft. Perspektiven.' :
  locale === 'en' ? 'Education. Community. Opportunities.' :
  'ការអប់រំ។ សហគមន៍។ ឱកាស។'
);

const description = t(data?.description, locale) || (
  locale === 'de' ? 'Wir glauben, dass jedes Kind eine faire chance verdient. Mit gezielten Bildungsprojekten schaffen wir nachhaltige Perspektiven vor Ort.' :
  locale === 'en' ? 'We believe every child deserves a fair chance. With targeted education projects, we create sustainable opportunities on the ground.' :
  'យើងជឿជាក់ថាកុមារគ្រប់រូបសមនឹងទទួលបានឱកាសដ៏ត្រឹមត្រូវ។'
);

// Hotspot support
const hotspot = data?.image?.hotspot;
const objectPosition = hotspot 
  ? `${hotspot.x * 100}% ${hotspot.y * 100}%` 
  : 'center center';
---

<section 
  id="start" 
  class="hero-container relative flex items-center overflow-hidden min-h-dvh bg-[#0d2a17]"
>
  <!-- Background Image Layer -->
  <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none">
    <div class="parallax-wrapper absolute inset-0 w-full h-full animate-fade-in" style="animation-delay: 0.2s;">
      <img 
        id="hero-parallax-img"
        src={heroImage}
        alt=""
        class="parallax-target absolute top-[-12%] left-0 w-full h-[120%] object-cover will-change-transform"
        style={`object-position: ${objectPosition};`}
      />
    </div>
    
    <!-- Overlays -->
    <div class="absolute inset-0 z-10 hidden md:block bg-[linear-gradient(to_right,rgba(13,42,23,0.95)_0%,rgba(13,42,23,0.85)_35%,rgba(13,42,23,0.2)_75%,transparent_100%)]"></div>
    <div class="absolute inset-0 z-10 md:hidden bg-[linear-gradient(to_top,rgba(13,42,23,0.95)_0%,rgba(13,42,23,0.4)_100%)]"></div>
    <div class="absolute inset-0 z-20 pointer-events-none shadow-[inset_0_0_200px_rgba(0,0,0,0.4)]"></div>
  </div>

  <!-- Content Container -->
  <div class="container-custom relative z-30 px-4 md:px-8 py-20">
    <div class="max-w-4xl border-l-[3px] border-secondary/40 pl-8 md:pl-16 py-8">
      <!-- Animated Line Accent (Vertical) -->
      <div class="w-16 h-[2px] bg-secondary mb-12 rounded-full animate-slide-left"></div>

      <h1 class="text-5xl md:text-7xl lg:text-8xl font-heading font-extrabold text-white leading-[1.05] mb-8 animate-reveal tracking-tighter">
        <span class="block opacity-0 translate-y-8 animate-item-reveal">{titleMain}</span>
        <span class="text-secondary block mt-2 opacity-0 translate-y-8 animate-item-reveal" style="animation-delay: 0.2s;">{titleAccent}</span>
      </h1>

      <p class="text-xs md:text-sm uppercase tracking-[0.5em] font-bold text-white/50 mb-10 opacity-0 animate-fade-in delay-500 italic">
        {subtitle}
      </p>

      <p class="text-white/80 text-lg md:text-2xl max-w-2xl mb-14 leading-relaxed font-light opacity-0 translate-y-6 animate-item-reveal" style="animation-delay: 0.4s;">
        {description}
      </p>

      <div class="flex flex-col sm:flex-row items-center gap-8 opacity-0 translate-y-6 animate-item-reveal" style="animation-delay: 0.6s;">
        <!-- <a href="#spenden" class="btn-donate group px-10 py-5 text-lg rounded-2xl w-full sm:w-auto text-center">
          <span>{locale === 'de' ? 'Jetzt unterstützen' : locale === 'en' ? 'Support now' : 'គាំទ្រឥឡូវ'}</span>
          <svg class="ml-2 w-5 h-5 transition-transform group-hover:translate-x-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a> -->
        <a href="#mission" class="group text-white/70 hover:text-white transition-all flex items-center gap-3 py-2 px-4 rounded-xl hover:bg-white/5">
          <span class="font-bold tracking-widest uppercase text-xs border-b border-transparent group-hover:border-secondary transition-all">
            {locale === 'de' ? 'Unsere Mission' : 'Our Mission'}
          </span>
          <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>
    </div>
  </div>

  <!-- Vertical Scroll Indicator -->
  <div class="absolute bottom-12 right-12 z-40 hidden xl:block opacity-0 animate-fade-in" style="animation-delay: 1.2s;">
    <div class="flex flex-col items-center gap-12">
      <span class="text-[10px] uppercase font-black tracking-[1.2em] text-white/30 [writing-mode:vertical-lr] whitespace-nowrap">{locale === 'de' ? 'Scrollen' : 'Scroll'}</span>
      <div class="w-[1px] h-32 bg-white/10 relative overflow-hidden">
        <div class="absolute inset-x-0 h-16 bg-gradient-to-b from-transparent via-secondary to-transparent animate-flow-line"></div>
      </div>
    </div>
  </div>
</section>

<style>
  .hero-container {
    view-timeline: --hero-v block;
  }

  @keyframes parallax-native {
    from { transform: translateY(0); }
    to { transform: translateY(20%); }
  }

  @supports (animation-timeline: view()) {
    .parallax-target {
      animation: parallax-native linear both;
      animation-timeline: --hero-v;
      animation-range: entry 0% exit 100%;
    }
  }

  /* Entrance Animations */
  @keyframes fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes item-reveal {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes slide-left {
    from { opacity: 0; transform: translateX(-50px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .animate-fade-in { animation: fade-in 1.5s ease-out forwards; }
  .animate-item-reveal { animation: item-reveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  .animate-slide-left { animation: slide-left 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

  @keyframes flowLine {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(300%); }
  }
  .animate-flow-line {
    animation: flowLine 4s infinite cubic-bezier(0.4, 0, 0.2, 1);
  }
</style>

<script is:inline>
  (function() {
    if (CSS.supports('animation-timeline', 'view()') || CSS.supports('animation-timeline', 'scroll()')) {
      return;
    }
    const img = document.getElementById('hero-parallax-img');
    const section = img?.closest('section');
    if (!img || !section) return;

    let ticking = false;
    const update = () => {
      const scrollY = window.scrollY || window.pageYOffset;
      const viewHeight = window.innerHeight;
      const sectionHeight = section.offsetHeight;
      
      if (scrollY < sectionHeight + viewHeight) {
        // Calculate scroll progress for the top section
        const scrolled = Math.min(1, scrollY / sectionHeight);
        // Match the 20% range of the CSS animation
        const yPos = scrolled * 20; 
        img.style.transform = `translate3d(0, ${yPos}%, 0)`;
      }
      ticking = false;
    };
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(update);
        ticking = true;
      }
    }, { passive: true });
    update();
  })();
</script>
