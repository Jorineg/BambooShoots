---
import Layout from "../../layouts/Layout.astro";
import { getLocale, t, localizedUrl, defaultLocale } from "../../lib/i18n";
import {
  getNewsPage,
  getNewsEntries,
  getSiteSettings,
} from "../../lib/sanity";
import SanityImage from "../../components/SanityImage.astro";
import { PortableText } from "astro-portabletext";

export async function getStaticPaths() {
  return [
    { params: { lang: undefined } },
    { params: { lang: "en" } },
    { params: { lang: "kh" } },
  ];
}

const { lang } = Astro.params;
const locale = (lang as any) || defaultLocale;

const newsPage = await getNewsPage();
const newsEntries = await getNewsEntries();
const settings = await getSiteSettings();

const pageTitle =
  t(newsPage?.heroTitle, locale) ||
  (locale === "de" ? "Aktuelles" : locale === "en" ? "News" : "ព័ត៌មានថ្មី");

function formatDate(dateStr: string) {
  if (!dateStr) return "";
  const date = new Date(dateStr + "T00:00:00");
  const loc = locale === "kh" ? "km-KH" : locale === "de" ? "de-DE" : "en-US";
  return date.toLocaleDateString(loc, {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<Layout title={pageTitle} locale={locale} seo={newsPage?.seo}>
  <!-- Hero -->
  <section
    class="pt-24 pb-16 md:pt-48 md:pb-32 bg-branding-bg relative overflow-hidden"
  >
    <div
      class="absolute top-0 right-0 w-[500px] h-[500px] bg-primary/5 rounded-full blur-[120px] -mr-64 -mt-64 pointer-events-none"
    >
    </div>

    <div class="container-custom px-6 md:px-0 relative z-10">
      <div
        class="max-w-4xl border-l-0 md:border-l-[3px] border-primary/20 pl-0 md:pl-16 reveal"
      >
        <h1
          class="text-4xl md:text-6xl lg:text-7xl font-heading font-extrabold text-branding-dark mb-6 tracking-tight leading-[1.1]"
        >
          {pageTitle}
        </h1>
      </div>
    </div>
  </section>

  <!-- News Entries -->
  <section class="py-16 md:py-32 bg-branding-bg">
    <div class="container-custom px-6 md:px-8">
      {newsEntries.length === 0 && (
        <p class="text-branding-muted text-lg text-center">
          {locale === "de"
            ? "Noch keine Einträge vorhanden."
            : locale === "en"
              ? "No entries yet."
              : "មិនទាន់មានធាតុនៅឡើយទេ។"}
        </p>
      )}

      <div class="max-w-5xl mx-auto">
        {newsEntries.map((entry: any, index: number) => {
          const body = entry.body?.[locale] || entry.body?.de;
          const title = t(entry.title, locale);

          return (
            <article
              class:list={[
                "reveal",
                index > 0 && "border-t border-black/10 pt-12 md:pt-16 mt-12 md:mt-16",
              ]}
            >
              <div class:list={[
                "flex flex-col gap-8 md:gap-12",
                entry.image && "lg:flex-row lg:items-start",
              ]}>
                <div class={entry.image ? "w-full lg:w-2/3" : "w-full"}>
                  {entry.date && (
                    <time
                      datetime={entry.date}
                      class="text-sm uppercase tracking-[0.15em] font-bold text-primary/70 mb-3 block"
                    >
                      {formatDate(entry.date)}
                    </time>
                  )}

                  {title && (
                    <h2 class="text-2xl md:text-4xl font-heading font-extrabold text-branding-dark mb-6 tracking-tight leading-tight">
                      {title}
                    </h2>
                  )}

                  {body && (
                    <div class="prose prose-lg max-w-none text-branding-text font-light leading-relaxed
                      prose-p:text-branding-text prose-p:text-lg prose-p:md:text-xl prose-p:leading-relaxed prose-p:font-light
                      prose-strong:text-branding-dark prose-strong:font-semibold
                      prose-a:text-primary prose-a:underline prose-a:decoration-primary/30 hover:prose-a:decoration-primary
                      prose-ul:my-4 prose-ol:my-4 prose-li:text-branding-text">
                      <PortableText value={body} />
                    </div>
                  )}
                </div>

                {entry.image && (
                  <div class="w-full lg:w-1/3 flex-shrink-0">
                    <div class="aspect-[4/3] rounded-2xl md:rounded-3xl overflow-hidden shadow-xl bg-branding-accent">
                      <SanityImage
                        src={entry.image}
                        alt={title || ""}
                        class="w-full h-full object-cover"
                        width={600}
                        aspectRatio={4 / 3}
                        widths={[300, 600, 900]}
                        sizes="(max-width: 1024px) 100vw, 33vw"
                      />
                    </div>
                  </div>
                )}
              </div>
            </article>
          );
        })}
      </div>

      <!-- Back to home -->
      <div class="text-center mt-16 md:mt-32 reveal">
        <a
          href={localizedUrl("/", locale)}
          class="group inline-flex items-center gap-4 text-branding-dark font-extrabold hover:text-primary transition-colors duration-500"
        >
          <div
            class="w-12 h-12 rounded-full border border-black/10 flex items-center justify-center group-hover:bg-primary group-hover:border-primary transition-all duration-500"
          >
            <svg
              class="w-5 h-5 group-hover:-translate-x-1 group-hover:text-white transition-all duration-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16l-4-4m0 0l4-4m-4 4h18"
              ></path>
            </svg>
          </div>
          <span
            class="text-sm uppercase tracking-[0.3em] border-b border-black/10 group-hover:border-primary transition-colors duration-500"
          >
            {t(settings?.labels?.backToHome, locale) ||
              (locale === "de"
                ? "Zur Startseite"
                : locale === "en"
                  ? "Back to Home"
                  : "ត្រឡប់ទៅទំព័រដើម")}
          </span>
        </a>
      </div>
    </div>
  </section>
</Layout>
